<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Cabs</title>

    <!-- Bootstrap & Leaflet CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body {
            background: linear-gradient(to right, #002f4b, #dc4225);
            font-family: 'Poppins', sans-serif;
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }
        .container {
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        input {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .btn {
            width: 100%;
            margin-top: 10px;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 10px;
            margin-top: 15px;
        }
        .loader {
            display: none;
            margin-top: 10px;
        }
        .icon-btn {
            background: none;
            border: none;
            border-radius: 200px;
            cursor: pointer;
            color: white;
            font-size: 20px;
            margin-left: 5px;
            margin-top: 15px;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div class="container">
    <h3>Find Nearby Cabs</h3>
    <div class="d-flex align-items-center">
        <input type="text" class="form-control mt-3" id="location" placeholder="Enter city or address">
        <button class="icon-btn" onclick="detectLocation()">üìç</button>
    </div>
    <button class="btn btn-warning" onclick="findCabs()">Find Cabs</button>
    <button class="btn btn-danger" onclick="clearSearch()">Clear</button>
    <div class="loader">
        <div class="spinner-border text-light" role="status"></div>
        <p>Searching for cabs...</p>
    </div>
    <div class="mt-3" id="result"></div>
    <div id="map"></div>
</div>

<script>
    let map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];
    let cabIcon = L.icon({
    iconUrl: "/static/images/taxi.png", //Taxi Icon (Can use a URL)
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -35]
});

    function clearSearch() {
        document.getElementById("location").value = "";
        document.getElementById("result").innerHTML = "";
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        map.setView([20.5937, 78.9629], 5);
    }

    async function findCabs() {
        const location = document.getElementById("location").value.trim();
        if (!location) {
            alert("Please enter a location.");
            return;
        }
        
        document.querySelector(".loader").style.display = "block";
        document.getElementById("result").innerHTML = "";
        
        try {
            const response = await fetch("/find_cabs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ location })
            });
            
            const data = await response.json();
            document.querySelector(".loader").style.display = "none";
            document.getElementById("result").innerHTML = data.result.replace(/\n/g, "<br>");
            updateMap(data.cabs);
        } catch (error) {
            document.querySelector(".loader").style.display = "none";
            document.getElementById("result").innerHTML = "<span class='text-danger'>An error occurred.</span>";
        }
    }

    function updateMap(cabs) {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        if (cabs.length === 0) {
            alert("No nearby cabs found.");
            return;
        }

        cabs.forEach(cab => {
            let marker = L.marker([cab.lat, cab.lon], { icon: cabIcon }).addTo(map)
                .bindPopup(`<b>${cab.name}</b><br>Driver ID: ${cab.id}<br>Phone: ${cab.phone}<br>Distance: ${cab.distance.toFixed(2)} km`);
            markers.push(marker);
        });
        
        map.setView([cabs[0].lat, cabs[0].lon], 12);
    }

    function detectLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                let resultDiv = document.getElementById("result");
                resultDiv.innerHTML = "Detecting location...";

                try {
                    let response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`, {
                        headers: { "User-Agent": "MyCabFinderApp/1.0 (cabfinder50@gmail.com)" }
                    });
                    let data = await response.json();
                    let detectedLocation = data.display_name || "Your location";
                    document.getElementById("location").value = detectedLocation;
                    resultDiv.innerHTML = `Detected Location: ${detectedLocation}`;
                    map.setView([latitude, longitude], 12);
                } catch (error) {
                    resultDiv.innerHTML = "<span class='text-danger'>Failed to detect location.</span>";
                }
            }, () => {
                alert("Location access denied.");
            });
        } else {
            alert("Geolocation is not supported.");
        }
    }

    map.on('click', async function (e) {
        const { lat, lng } = e.latlng;
        try {
            let response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
                headers: { "User-Agent": "MyCabFinderApp/1.0 (cabfinder50@gmail.com)" }
            });
            let data = await response.json();
            let selectedLocation = data.display_name || `${lat}, ${lng}`;
            document.getElementById("location").value = selectedLocation;
        } catch (error) {
            alert("Failed to fetch location details.");
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
